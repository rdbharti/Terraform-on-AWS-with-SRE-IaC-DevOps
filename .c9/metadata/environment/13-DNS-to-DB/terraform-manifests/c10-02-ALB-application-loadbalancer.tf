{"filter":false,"title":"c10-02-ALB-application-loadbalancer.tf","tooltip":"/13-DNS-to-DB/terraform-manifests/c10-02-ALB-application-loadbalancer.tf","undoManager":{"mark":49,"position":49,"stack":[[{"start":{"row":93,"column":5},"end":{"row":93,"column":6},"action":"insert","lines":[","],"id":4}],[{"start":{"row":93,"column":6},"end":{"row":94,"column":0},"action":"insert","lines":["",""],"id":5},{"start":{"row":94,"column":0},"end":{"row":94,"column":4},"action":"insert","lines":["    "]},{"start":{"row":94,"column":4},"end":{"row":95,"column":0},"action":"insert","lines":["",""]},{"start":{"row":95,"column":0},"end":{"row":95,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":95,"column":4},"end":{"row":95,"column":5},"action":"insert","lines":["{"],"id":6},{"start":{"row":95,"column":5},"end":{"row":95,"column":6},"action":"insert","lines":["}"]},{"start":{"row":95,"column":6},"end":{"row":95,"column":7},"action":"insert","lines":[","]}],[{"start":{"row":95,"column":5},"end":{"row":97,"column":4},"action":"insert","lines":["","      ","    "],"id":7}],[{"start":{"row":96,"column":6},"end":{"row":97,"column":0},"action":"insert","lines":["",""],"id":8},{"start":{"row":97,"column":0},"end":{"row":97,"column":6},"action":"insert","lines":["      "]},{"start":{"row":97,"column":6},"end":{"row":98,"column":0},"action":"insert","lines":["",""]},{"start":{"row":98,"column":0},"end":{"row":98,"column":6},"action":"insert","lines":["      "]}],[{"start":{"row":96,"column":6},"end":{"row":97,"column":0},"action":"insert","lines":["",""],"id":9},{"start":{"row":97,"column":0},"end":{"row":97,"column":6},"action":"insert","lines":["      "]},{"start":{"row":97,"column":6},"end":{"row":98,"column":0},"action":"insert","lines":["",""]},{"start":{"row":98,"column":0},"end":{"row":98,"column":6},"action":"insert","lines":["      "]}],[{"start":{"row":98,"column":6},"end":{"row":128,"column":50},"action":"insert","lines":["# App2 Target Group - TG Index = 1","    {","      name_prefix          = \"app2-\"","      backend_protocol     = \"HTTP\"","      backend_port         = 80","      target_type          = \"instance\"","      deregistration_delay = 10","      health_check = {","        enabled             = true","        interval            = 30","        path                = \"/app2/index.html\"","        port                = \"traffic-port\"","        healthy_threshold   = 3","        unhealthy_threshold = 3","        timeout             = 6","        protocol            = \"HTTP\"","        matcher             = \"200-399\"","      }","      protocol_version = \"HTTP1\"","      # App2 Target Group - Targets","      targets = {","        my_app2_vm1 = {","          target_id = module.ec2_private_app2.id[0]","          port      = 80","        },","        my_app2_vm2 = {","          target_id = module.ec2_private_app2.id[1]","          port      = 80","        }","      }","      tags = local.common_tags # Target Group Tags"],"id":10}],[{"start":{"row":99,"column":1},"end":{"row":99,"column":5},"action":"remove","lines":["   {"],"id":11},{"start":{"row":99,"column":0},"end":{"row":99,"column":1},"action":"remove","lines":[" "]},{"start":{"row":98,"column":40},"end":{"row":99,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":98,"column":0},"end":{"row":98,"column":40},"action":"remove","lines":["      # App2 Target Group - TG Index = 1"],"id":12}],[{"start":{"row":97,"column":6},"end":{"row":98,"column":0},"action":"remove","lines":["",""],"id":13},{"start":{"row":97,"column":4},"end":{"row":97,"column":6},"action":"remove","lines":["  "]},{"start":{"row":97,"column":2},"end":{"row":97,"column":4},"action":"remove","lines":["  "]},{"start":{"row":97,"column":0},"end":{"row":97,"column":2},"action":"remove","lines":["  "]},{"start":{"row":96,"column":6},"end":{"row":97,"column":0},"action":"remove","lines":["",""]},{"start":{"row":96,"column":4},"end":{"row":96,"column":6},"action":"remove","lines":["  "]},{"start":{"row":96,"column":2},"end":{"row":96,"column":4},"action":"remove","lines":["  "]}],[{"start":{"row":96,"column":0},"end":{"row":96,"column":2},"action":"remove","lines":["  "],"id":14},{"start":{"row":95,"column":5},"end":{"row":96,"column":0},"action":"remove","lines":["",""]}],[{"start":{"row":94,"column":4},"end":{"row":95,"column":0},"action":"insert","lines":["",""],"id":15},{"start":{"row":95,"column":0},"end":{"row":95,"column":4},"action":"insert","lines":["    "]}],[{"start":{"row":95,"column":4},"end":{"row":95,"column":44},"action":"insert","lines":["      # App2 Target Group - TG Index = 1"],"id":16}],[{"start":{"row":95,"column":15},"end":{"row":95,"column":16},"action":"remove","lines":["2"],"id":17}],[{"start":{"row":95,"column":15},"end":{"row":95,"column":16},"action":"insert","lines":["3"],"id":18}],[{"start":{"row":95,"column":43},"end":{"row":95,"column":44},"action":"remove","lines":["1"],"id":19},{"start":{"row":95,"column":43},"end":{"row":95,"column":44},"action":"insert","lines":["2"]}],[{"start":{"row":97,"column":33},"end":{"row":97,"column":34},"action":"remove","lines":["2"],"id":20},{"start":{"row":97,"column":33},"end":{"row":97,"column":34},"action":"insert","lines":["3"]}],[{"start":{"row":105,"column":31},"end":{"row":105,"column":47},"action":"remove","lines":["/app2/index.html"],"id":21},{"start":{"row":105,"column":31},"end":{"row":105,"column":32},"action":"insert","lines":["/"]},{"start":{"row":105,"column":32},"end":{"row":105,"column":33},"action":"insert","lines":["l"]},{"start":{"row":105,"column":33},"end":{"row":105,"column":34},"action":"insert","lines":["o"]},{"start":{"row":105,"column":34},"end":{"row":105,"column":35},"action":"insert","lines":["g"]},{"start":{"row":105,"column":35},"end":{"row":105,"column":36},"action":"insert","lines":["i"]},{"start":{"row":105,"column":36},"end":{"row":105,"column":37},"action":"insert","lines":["n"]}],[{"start":{"row":114,"column":11},"end":{"row":114,"column":12},"action":"remove","lines":["2"],"id":22},{"start":{"row":114,"column":11},"end":{"row":114,"column":12},"action":"insert","lines":["3"]}],[{"start":{"row":99,"column":31},"end":{"row":99,"column":32},"action":"insert","lines":["8"],"id":23},{"start":{"row":99,"column":32},"end":{"row":99,"column":33},"action":"insert","lines":["0"]}],[{"start":{"row":118,"column":24},"end":{"row":118,"column":25},"action":"insert","lines":["8"],"id":24},{"start":{"row":118,"column":25},"end":{"row":118,"column":26},"action":"insert","lines":["0"]}],[{"start":{"row":122,"column":24},"end":{"row":122,"column":25},"action":"insert","lines":["8"],"id":25},{"start":{"row":122,"column":25},"end":{"row":122,"column":26},"action":"insert","lines":["0"]}],[{"start":{"row":116,"column":14},"end":{"row":116,"column":15},"action":"remove","lines":["2"],"id":26},{"start":{"row":116,"column":14},"end":{"row":116,"column":15},"action":"insert","lines":["3"]}],[{"start":{"row":120,"column":14},"end":{"row":120,"column":15},"action":"remove","lines":["2"],"id":27},{"start":{"row":120,"column":14},"end":{"row":120,"column":15},"action":"insert","lines":["3"]}],[{"start":{"row":112,"column":7},"end":{"row":113,"column":0},"action":"insert","lines":["",""],"id":28},{"start":{"row":113,"column":0},"end":{"row":113,"column":6},"action":"insert","lines":["      "]},{"start":{"row":113,"column":6},"end":{"row":114,"column":0},"action":"insert","lines":["",""]},{"start":{"row":114,"column":0},"end":{"row":114,"column":6},"action":"insert","lines":["      "]},{"start":{"row":114,"column":6},"end":{"row":114,"column":7},"action":"insert","lines":["s"]},{"start":{"row":114,"column":7},"end":{"row":114,"column":8},"action":"insert","lines":["t"]},{"start":{"row":114,"column":8},"end":{"row":114,"column":9},"action":"insert","lines":["i"]},{"start":{"row":114,"column":9},"end":{"row":114,"column":10},"action":"insert","lines":["c"]},{"start":{"row":114,"column":10},"end":{"row":114,"column":11},"action":"insert","lines":["k"]},{"start":{"row":114,"column":11},"end":{"row":114,"column":12},"action":"insert","lines":["i"]},{"start":{"row":114,"column":12},"end":{"row":114,"column":13},"action":"insert","lines":["n"]},{"start":{"row":114,"column":13},"end":{"row":114,"column":14},"action":"insert","lines":["e"]}],[{"start":{"row":114,"column":14},"end":{"row":114,"column":15},"action":"insert","lines":["s"],"id":29},{"start":{"row":114,"column":15},"end":{"row":114,"column":16},"action":"insert","lines":["s"]}],[{"start":{"row":114,"column":16},"end":{"row":115,"column":0},"action":"insert","lines":["",""],"id":30},{"start":{"row":115,"column":0},"end":{"row":115,"column":6},"action":"insert","lines":["      "]},{"start":{"row":115,"column":6},"end":{"row":116,"column":0},"action":"insert","lines":["",""]},{"start":{"row":116,"column":0},"end":{"row":116,"column":6},"action":"insert","lines":["      "]}],[{"start":{"row":114,"column":16},"end":{"row":114,"column":17},"action":"insert","lines":[" "],"id":31},{"start":{"row":114,"column":17},"end":{"row":114,"column":18},"action":"insert","lines":["="]}],[{"start":{"row":114,"column":18},"end":{"row":114,"column":19},"action":"insert","lines":[" "],"id":32},{"start":{"row":114,"column":19},"end":{"row":114,"column":20},"action":"insert","lines":["{"]},{"start":{"row":114,"column":20},"end":{"row":114,"column":21},"action":"insert","lines":["}"]}],[{"start":{"row":114,"column":20},"end":{"row":116,"column":6},"action":"insert","lines":["","        ","      "],"id":33}],[{"start":{"row":115,"column":8},"end":{"row":115,"column":9},"action":"insert","lines":["e"],"id":34},{"start":{"row":115,"column":9},"end":{"row":115,"column":10},"action":"insert","lines":["n"]},{"start":{"row":115,"column":10},"end":{"row":115,"column":11},"action":"insert","lines":["a"]}],[{"start":{"row":115,"column":8},"end":{"row":115,"column":11},"action":"remove","lines":["ena"],"id":35},{"start":{"row":115,"column":8},"end":{"row":115,"column":15},"action":"insert","lines":["enabled"]}],[{"start":{"row":115,"column":15},"end":{"row":115,"column":16},"action":"insert","lines":[" "],"id":36},{"start":{"row":115,"column":16},"end":{"row":115,"column":17},"action":"insert","lines":["="]}],[{"start":{"row":115,"column":17},"end":{"row":115,"column":18},"action":"insert","lines":[" "],"id":37},{"start":{"row":115,"column":18},"end":{"row":115,"column":19},"action":"insert","lines":["t"]},{"start":{"row":115,"column":19},"end":{"row":115,"column":20},"action":"insert","lines":["r"]},{"start":{"row":115,"column":20},"end":{"row":115,"column":21},"action":"insert","lines":["u"]},{"start":{"row":115,"column":21},"end":{"row":115,"column":22},"action":"insert","lines":["e"]}],[{"start":{"row":115,"column":22},"end":{"row":116,"column":0},"action":"insert","lines":["",""],"id":38},{"start":{"row":116,"column":0},"end":{"row":116,"column":8},"action":"insert","lines":["        "]},{"start":{"row":116,"column":8},"end":{"row":116,"column":9},"action":"insert","lines":["c"]},{"start":{"row":116,"column":9},"end":{"row":116,"column":10},"action":"insert","lines":["o"]},{"start":{"row":116,"column":10},"end":{"row":116,"column":11},"action":"insert","lines":["o"]},{"start":{"row":116,"column":11},"end":{"row":116,"column":12},"action":"insert","lines":["k"]}],[{"start":{"row":116,"column":12},"end":{"row":116,"column":13},"action":"insert","lines":["u"],"id":39}],[{"start":{"row":116,"column":12},"end":{"row":116,"column":13},"action":"remove","lines":["u"],"id":40}],[{"start":{"row":116,"column":12},"end":{"row":116,"column":13},"action":"insert","lines":["i"],"id":41},{"start":{"row":116,"column":13},"end":{"row":116,"column":14},"action":"insert","lines":["e"]},{"start":{"row":116,"column":14},"end":{"row":116,"column":15},"action":"insert","lines":["_"]},{"start":{"row":116,"column":15},"end":{"row":116,"column":16},"action":"insert","lines":["d"]},{"start":{"row":116,"column":16},"end":{"row":116,"column":17},"action":"insert","lines":["u"]},{"start":{"row":116,"column":17},"end":{"row":116,"column":18},"action":"insert","lines":["r"]},{"start":{"row":116,"column":18},"end":{"row":116,"column":19},"action":"insert","lines":["a"]}],[{"start":{"row":116,"column":19},"end":{"row":116,"column":20},"action":"insert","lines":["t"],"id":42},{"start":{"row":116,"column":20},"end":{"row":116,"column":21},"action":"insert","lines":["i"]},{"start":{"row":116,"column":21},"end":{"row":116,"column":22},"action":"insert","lines":["o"]},{"start":{"row":116,"column":22},"end":{"row":116,"column":23},"action":"insert","lines":["n"]}],[{"start":{"row":116,"column":23},"end":{"row":116,"column":24},"action":"insert","lines":[" "],"id":43},{"start":{"row":116,"column":24},"end":{"row":116,"column":25},"action":"insert","lines":["="]}],[{"start":{"row":116,"column":25},"end":{"row":116,"column":26},"action":"insert","lines":[" "],"id":44},{"start":{"row":116,"column":26},"end":{"row":116,"column":27},"action":"insert","lines":["8"]}],[{"start":{"row":116,"column":27},"end":{"row":116,"column":28},"action":"insert","lines":["6"],"id":45},{"start":{"row":116,"column":28},"end":{"row":116,"column":29},"action":"insert","lines":["4"]},{"start":{"row":116,"column":29},"end":{"row":116,"column":30},"action":"insert","lines":["0"]},{"start":{"row":116,"column":30},"end":{"row":116,"column":31},"action":"insert","lines":["0"]}],[{"start":{"row":116,"column":31},"end":{"row":117,"column":0},"action":"insert","lines":["",""],"id":46},{"start":{"row":117,"column":0},"end":{"row":117,"column":8},"action":"insert","lines":["        "]},{"start":{"row":117,"column":8},"end":{"row":117,"column":9},"action":"insert","lines":["t"]},{"start":{"row":117,"column":9},"end":{"row":117,"column":10},"action":"insert","lines":["y"]},{"start":{"row":117,"column":10},"end":{"row":117,"column":11},"action":"insert","lines":["p"]},{"start":{"row":117,"column":11},"end":{"row":117,"column":12},"action":"insert","lines":["e"]}],[{"start":{"row":117,"column":12},"end":{"row":117,"column":13},"action":"insert","lines":[" "],"id":47},{"start":{"row":117,"column":13},"end":{"row":117,"column":14},"action":"insert","lines":["="]}],[{"start":{"row":117,"column":14},"end":{"row":117,"column":15},"action":"insert","lines":[" "],"id":48}],[{"start":{"row":117,"column":15},"end":{"row":117,"column":17},"action":"insert","lines":["\"\""],"id":49}],[{"start":{"row":117,"column":16},"end":{"row":117,"column":17},"action":"insert","lines":["l"],"id":50},{"start":{"row":117,"column":17},"end":{"row":117,"column":18},"action":"insert","lines":["b"]},{"start":{"row":117,"column":18},"end":{"row":117,"column":19},"action":"insert","lines":["_"]}],[{"start":{"row":117,"column":19},"end":{"row":117,"column":20},"action":"insert","lines":["c"],"id":51},{"start":{"row":117,"column":20},"end":{"row":117,"column":21},"action":"insert","lines":["o"]},{"start":{"row":117,"column":21},"end":{"row":117,"column":22},"action":"insert","lines":["o"]},{"start":{"row":117,"column":22},"end":{"row":117,"column":23},"action":"insert","lines":["k"]},{"start":{"row":117,"column":23},"end":{"row":117,"column":24},"action":"insert","lines":["i"]},{"start":{"row":117,"column":24},"end":{"row":117,"column":25},"action":"insert","lines":["e"]}],[{"start":{"row":0,"column":0},"end":{"row":450,"column":3},"action":"remove","lines":["# Terraform AWS Application Load Balancer (ALB)","module \"alb\" {","  source = \"terraform-aws-modules/alb/aws\"","  #version = \"5.16.0\"","  version = \"6.0.0\"","","  name               = \"${local.name}-alb\"","  load_balancer_type = \"application\"","  vpc_id             = module.vpc.vpc_id","  subnets = [","    module.vpc.public_subnets[0],","    module.vpc.public_subnets[1]","  ]","  security_groups = [module.loadbalancer_sg.security_group_id]","  # Listeners","  # HTTP Listener - HTTP to HTTPS Redirect","  http_tcp_listeners = [","    {","      port        = 80","      protocol    = \"HTTP\"","      action_type = \"redirect\"","      redirect = {","        port        = \"443\"","        protocol    = \"HTTPS\"","        status_code = \"HTTP_301\"","      }","    }","  ]","  # Target Groups","  target_groups = [","    # App1 Target Group - TG Index = 0","    {","      name_prefix          = \"app1-\"","      backend_protocol     = \"HTTP\"","      backend_port         = 80","      target_type          = \"instance\"","      deregistration_delay = 10","      health_check = {","        enabled             = true","        interval            = 30","        path                = \"/app1/index.html\"","        port                = \"traffic-port\"","        healthy_threshold   = 3","        unhealthy_threshold = 3","        timeout             = 6","        protocol            = \"HTTP\"","        matcher             = \"200-399\"","      }","      protocol_version = \"HTTP1\"","      # App1 Target Group - Targets","      targets = {","        my_app1_vm1 = {","          target_id = module.ec2_private_app1.id[0]","          port      = 80","        },","        my_app1_vm2 = {","          target_id = module.ec2_private_app1.id[1]","          port      = 80","        }","      }","      tags = local.common_tags # Target Group Tags","    },","    # App2 Target Group - TG Index = 1","    {","      name_prefix          = \"app2-\"","      backend_protocol     = \"HTTP\"","      backend_port         = 80","      target_type          = \"instance\"","      deregistration_delay = 10","      health_check = {","        enabled             = true","        interval            = 30","        path                = \"/app2/index.html\"","        port                = \"traffic-port\"","        healthy_threshold   = 3","        unhealthy_threshold = 3","        timeout             = 6","        protocol            = \"HTTP\"","        matcher             = \"200-399\"","      }","      protocol_version = \"HTTP1\"","      # App2 Target Group - Targets","      targets = {","        my_app2_vm1 = {","          target_id = module.ec2_private_app2.id[0]","          port      = 80","        },","        my_app2_vm2 = {","          target_id = module.ec2_private_app2.id[1]","          port      = 80","        }","      }","      tags = local.common_tags # Target Group Tags","    },","    ","          # App3 Target Group - TG Index = 2","    {","      name_prefix          = \"app3-\"","      backend_protocol     = \"HTTP\"","      backend_port         = 8080","      target_type          = \"instance\"","      deregistration_delay = 10","      health_check = {","        enabled             = true","        interval            = 30","        path                = \"/login\"","        port                = \"traffic-port\"","        healthy_threshold   = 3","        unhealthy_threshold = 3","        timeout             = 6","        protocol            = \"HTTP\"","        matcher             = \"200-399\"","      }","      ","      stickiness = {","        enabled = true","        cookie_duration = 86400","        type = \"lb_cookie\"","      }","      ","      ","      protocol_version = \"HTTP1\"","      # App3 Target Group - Targets","      targets = {","        my_app3_vm1 = {","          target_id = module.ec2_private_app2.id[0]","          port      = 8080","        },","        my_app3_vm2 = {","          target_id = module.ec2_private_app2.id[1]","          port      = 8080","        }","      }","      tags = local.common_tags # Target Group Tags","      ","      ","    },","  ]","","  # HTTPS Listener","  https_listeners = [","    # HTTPS Listener Index = 0 for HTTPS 443","    {","      port            = 443","      protocol        = \"HTTPS\"","      certificate_arn = module.acm.acm_certificate_arn","      action_type     = \"fixed-response\"","      fixed_response = {","        content_type = \"text/plain\"","        message_body = \"Fixed Static message - for Root Context\"","        status_code  = \"200\"","      }","    },","  ]","","  # HTTPS Listener Rules","  https_listener_rules = [","    # Rule-1: custom-header=my-app-1 should go to App1 EC2 Instances","    {","      https_listener_index = 0","      priority             = 1","      actions = [","        {","          type               = \"forward\"","          target_group_index = 0","        }","      ]","      conditions = [{","        #path_patterns = [\"/app1*\"]","        #host_headers = [var.app1_dns_name]","        http_headers = [{","          http_header_name = \"custom-header\"","          values           = [\"app-1\", \"app1\", \"my-app-1\"]","        }]","      }]","    },","    # Rule-2: custom-header=my-app-2 should go to App2 EC2 Instances    ","    {","      https_listener_index = 0","      priority             = 2","      actions = [","        {","          type               = \"forward\"","          target_group_index = 1","        }","      ]","      conditions = [{","        #path_patterns = [\"/app2*\"] ","        #host_headers = [var.app2_dns_name]","        http_headers = [{","          http_header_name = \"custom-header\"","          values           = [\"app-2\", \"app2\", \"my-app-2\"]","        }]","      }]","    },","    # Rule-3: When Query-String, website=aws-eks redirect to https://stacksimplify.com/aws-eks/","    {","      https_listener_index = 0","      priority             = 3","      actions = [{","        type        = \"redirect\"","        status_code = \"HTTP_302\"","        host        = \"stacksimplify.com\"","        path        = \"/aws-eks/\"","        query       = \"\"","        protocol    = \"HTTPS\"","      }]","      conditions = [{","        query_strings = [{","          key   = \"website\"","          value = \"aws-eks\"","        }]","      }]","    },","    # Rule-4: When Host Header = azure-aks.ranadurlabh.in, redirect to https://stacksimplify.com/azure-aks/azure-kubernetes-service-introduction/","    {","      https_listener_index = 0","      priority             = 4","      actions = [{","        type        = \"redirect\"","        status_code = \"HTTP_302\"","        host        = \"stacksimplify.com\"","        path        = \"/azure-aks/azure-kubernetes-service-introduction/\"","        query       = \"\"","        protocol    = \"HTTPS\"","      }]","      conditions = [{","        host_headers = [\"azure-aks101.ranadurlabh.in\"]","      }]","    },","  ]","  tags = local.common_tags # ALB Tags","}","","","##############################################","","","","","# module \"alb\" {","#   source  = \"terraform-aws-modules/alb/aws\"","#   version = \"6.0.0\"","","#   name               = \"${local.name}-alb\"","#   load_balancer_type = \"application\"","#   subnets            = [module.vpc.public_subnets[0], module.vpc.public_subnets[1]] ","#   vpc_id             = module.vpc.vpc_id","","#   security_groups = [module.loadbalancer_sg.this_security_group_id]","","#   tags = local.common_tags # ALB - TAGS","","#   # Listeners","#   http_tcp_listeners = [","#     {","#       port     = 80","#       protocol = \"HTTP\"","","#       action_type = \"redirect\"","#       redirect = {","#         port        = \"443\"","#         protocol    = \"HTTPS\"","#         status_code = \"HTTP_301\"","#       }","#     }","#   ]","","#   # Targets Groups","#   target_groups = [","","#     # App1 Target Group - TG index = 0","#     {","#       name_prefix          = \"app1-\"","#       backend_protocol     = \"HTTP\"","#       backend_port         = 80","#       target_type          = \"instance\"","#       deregistration_delay = 10","#       health_check = {","#         enabled             = true","#         interval            = 30","#         path                = \"/app1/index.html\"","#         port                = \"traffic-port\"","#         healthy_threshold   = 3","#         unhealthy_threshold = 3","#         timeout             = 6","#         protocol            = \"HTTP\"","#         matcher             = \"200-399\"","#       }","#       protocol_version = \"HTTP1\"","","#       # App1 Target Group - Targets","#       targets = {","#         my_app1_vm1 = {","#           target_id = module.ec2_private_app1.id[0]","#           port      = 80","#         },","#         my_app1_vm2 = {","#           target_id = module.ec2_private_app1.id[1]","#           port      = 80","#         }","#       }","#       tags = local.common_tags # Target Group related Tags","#     },","","#     # App2 Target Group - TG index = 1","#     {","#       name_prefix          = \"app2-\"","#       backend_protocol     = \"HTTP\"","#       backend_port         = 80","#       target_type          = \"instance\"","#       deregistration_delay = 10","#       health_check = {","#         enabled             = true","#         interval            = 30","#         path                = \"/app2/index.html\"","#         port                = \"traffic-port\"","#         healthy_threshold   = 3","#         unhealthy_threshold = 3","#         timeout             = 6","#         protocol            = \"HTTP\"","#         matcher             = \"200-399\"","#       }","#       protocol_version = \"HTTP1\"","","#       # App2 Target Group - Targets","#       targets = {","#         my_app2_vm1 = {","#           target_id = module.ec2_private_app2.id[0]","#           port      = 80","#         },","#         my_app2_vm2 = {","#           target_id = module.ec2_private_app2.id[1]","#           port      = 80","#         }","#       }","#       tags = local.common_tags # Target Group related Tags","#     }","#   ]","","#   # HTTPS Listener","#   https_listeners = [","#     # HTTPS Listener Index = 0 for HTTPS 443","#     {","#       port            = 443","#       protocol        = \"HTTPS\"","#       certificate_arn = module.acm.this_acm_certificate_arn","#       action_type     = \"fixed-response\"","#       fixed_response = {","#         content_type = \"text/plain\"","#         message_body = \"Fixed Static message - for Root Context\"","#         status_code  = \"200\"","#       }","#     },","#   ]","","#   # HTTPS Listener Rules","#   https_listener_rules = [","#     # Rule 1: custom-header = my-app-1 should go to App1 EC2 Instances","#     {","#       https_listener_index = 0","#       priority             = 1","","#       actions = [","#         {","#           type               = \"forward\"","#           target_group_index = 0","#         }","#       ]","","#       conditions = [{","#         # path_patterns = [\"/app1*\"]","#         # host_headers = [var.app1_dns_name] # app1.ranadurlabh.in","#         http_headers = [{","#           http_header_name = \"custom-header\"","#           values           = [\"app-1\", \"app1\", \"my-app-1\"]","#         }]","#       }]","#     },","","#     # Rule 2: /app2* should go to App2 EC2 Instances","#     {","#       https_listener_index = 0","#       priority             = 2","","#       actions = [","#         {","#           type               = \"forward\"","#           target_group_index = 1","#         }","#       ]","","#       conditions = [{","#         # path_patterns = [\"/app2*\"]","#         # host_headers = [var.app2_dns_name] # app2.ranadurlabh.in","#         http_headers = [{","#           http_header_name = \"custom-header\"","#           values           = [\"app-2\", \"app2\", \"my-app-2\"]","#         }]","#       }]","#     },","","#     # Rule 3: When Query-String, website=aws-eks redirect to https://google.com","#     {","#       http_listener_index = 0","#       priority            = 3","","#       actions = [{","#         type        = \"redirect\"","#         status_code = \"HTTP_302\"","#         host        = \"google.com\"","#         path        = \"/aws-eks/\"","#         query       = \"\"","#         protocol    = \"HTTPS\"","#       }]","","#       conditions = [{","","#         query_strings = [{","#           key   = \"website\"","#           value = \"aws-eks\"","#         }]","","#       }]","","#     },","","#     # Rule 4: When Host Header = azure-aks.ranadurlabh.in  redirect to yahoo.com","#     {","#       https_listener_index = 0","#       priority             = 4","","#       actions = [{","#         type        = \"redirect\"","#         status_code = \"HTTP_302\"","#         host        = \"stacksimplify.com\"","#         path        = \"/azure-aks/azure-kubernetes-service-introduction/\"","#         query       = \"\"","#         protocol    = \"HTTPS\"","#       }]","","#       conditions = [{","#         host_headers = [\"azure-aks101.ranadurlabh.in\"]","#       }]","","","#     },","","#   ]","","# }"],"id":52},{"start":{"row":0,"column":0},"end":{"row":199,"column":0},"action":"insert","lines":["# Terraform AWS Application Load Balancer (ALB)","module \"alb\" {","  source  = \"terraform-aws-modules/alb/aws\"","  #version = \"5.16.0\"","  version = \"6.0.0\"","","  name = \"${local.name}-alb\"","  load_balancer_type = \"application\"","  vpc_id = module.vpc.vpc_id","  subnets = [","    module.vpc.public_subnets[0],","    module.vpc.public_subnets[1]","  ]","  #security_groups = [module.loadbalancer_sg.this_security_group_id]","  security_groups = [module.loadbalancer_sg.security_group_id]","  # Listeners","  # HTTP Listener - HTTP to HTTPS Redirect","    http_tcp_listeners = [","    {","      port               = 80","      protocol           = \"HTTP\"","      action_type = \"redirect\"","      redirect = {","        port        = \"443\"","        protocol    = \"HTTPS\"","        status_code = \"HTTP_301\"","      }","    }","  ]  ","  # Target Groups","  target_groups = [","    # App1 Target Group - TG Index = 0","    {","      name_prefix          = \"app1-\"","      backend_protocol     = \"HTTP\"","      backend_port         = 80","      target_type          = \"instance\"","      deregistration_delay = 10","      health_check = {","        enabled             = true","        interval            = 30","        path                = \"/app1/index.html\"","        port                = \"traffic-port\"","        healthy_threshold   = 3","        unhealthy_threshold = 3","        timeout             = 6","        protocol            = \"HTTP\"","        matcher             = \"200-399\"","      }","      protocol_version = \"HTTP1\"","      # App1 Target Group - Targets","      targets = {","        my_app1_vm1 = {","          target_id = module.ec2_private_app1.id[0]","          port      = 80","        },","        my_app1_vm2 = {","          target_id = module.ec2_private_app1.id[1]","          port      = 80","        }","      }","      tags =local.common_tags # Target Group Tags","    },  ","    # App2 Target Group - TG Index = 1","    {","      name_prefix          = \"app2-\"","      backend_protocol     = \"HTTP\"","      backend_port         = 80","      target_type          = \"instance\"","      deregistration_delay = 10","      health_check = {","        enabled             = true","        interval            = 30","        path                = \"/app2/index.html\"","        port                = \"traffic-port\"","        healthy_threshold   = 3","        unhealthy_threshold = 3","        timeout             = 6","        protocol            = \"HTTP\"","        matcher             = \"200-399\"","      }","      protocol_version = \"HTTP1\"","      # App2 Target Group - Targets","      targets = {","        my_app2_vm1 = {","          target_id = module.ec2_private_app2.id[0]","          port      = 80","        },","        my_app2_vm2 = {","          target_id = module.ec2_private_app2.id[1]","          port      = 80","        }","      }","      tags =local.common_tags # Target Group Tags","    },  ","    # App3 Target Group - TG Index = 2","    {","      name_prefix          = \"app3-\"","      backend_protocol     = \"HTTP\"","      backend_port         = 8080","      target_type          = \"instance\"","      deregistration_delay = 10 ","      health_check = {","        enabled             = true","        interval            = 30","        path                = \"/login\"","        port                = \"traffic-port\"","        healthy_threshold   = 3","        unhealthy_threshold = 3","        timeout             = 6","        protocol            = \"HTTP\"","        matcher             = \"200-399\"","      }","      stickiness = {","        enabled = true","        cookie_duration = 86400","        type = \"lb_cookie\"","      }","      protocol_version = \"HTTP1\"","      # App3 Target Group - Targets","      targets = {","        my_app3_vm1 = {","          target_id = module.ec2_private_app3.id[0]","          port      = 8080","        },","        my_app3_vm2 = {","          target_id = module.ec2_private_app3.id[1]","          port      = 8080","        }","      }","      tags =local.common_tags # Target Group Tags","    }      ","  ]","","  # HTTPS Listener","  https_listeners = [","    # HTTPS Listener Index = 0 for HTTPS 443","    {","      port               = 443","      protocol           = \"HTTPS\"","      #certificate_arn    = module.acm.this_acm_certificate_arn","      certificate_arn    = module.acm.acm_certificate_arn","      action_type = \"fixed-response\"","      fixed_response = {","        content_type = \"text/plain\"","        message_body = \"Fixed Static message - for Root Context\"","        status_code  = \"200\"","      }","    }, ","  ]","","  # HTTPS Listener Rules","  https_listener_rules = [","    # Rule-1: /app1* should go to App1 EC2 Instances","    { ","      https_listener_index = 0","      priority = 1","      actions = [","        {","          type               = \"forward\"","          target_group_index = 0","        }","      ]","      conditions = [{","        path_patterns = [\"/app1*\"]","      }]","    },","    # Rule-2: /app2* should go to App2 EC2 Instances    ","    {","      https_listener_index = 0","      priority = 2      ","      actions = [","        {","          type               = \"forward\"","          target_group_index = 1","        }","      ]","      conditions = [{","        path_patterns = [\"/app2*\"]","      }]","    },","    # Rule-3: /* should go to App3 - User-mgmt-WebApp EC2 Instances    ","    {","      https_listener_index = 0","      priority = 3      ","      actions = [","        {","          type               = \"forward\"","          target_group_index = 2","        }","      ]","      conditions = [{","        path_patterns = [\"/*\"]","      }]","    },         ","  ]","","  tags = local.common_tags # ALB Tags","}",""]}],[{"start":{"row":2,"column":9},"end":{"row":2,"column":10},"action":"remove","lines":[" "],"id":53,"ignore":true},{"start":{"row":6,"column":7},"end":{"row":6,"column":21},"action":"insert","lines":["              "]},{"start":{"row":8,"column":9},"end":{"row":8,"column":21},"action":"insert","lines":["            "]},{"start":{"row":17,"column":0},"end":{"row":17,"column":2},"action":"remove","lines":["  "]},{"start":{"row":19,"column":18},"end":{"row":19,"column":25},"action":"remove","lines":["       "]},{"start":{"row":20,"column":18},"end":{"row":20,"column":25},"action":"remove","lines":["       "]},{"start":{"row":28,"column":3},"end":{"row":28,"column":5},"action":"remove","lines":["  "]},{"start":{"row":61,"column":12},"end":{"row":61,"column":13},"action":"insert","lines":[" "]},{"start":{"row":62,"column":6},"end":{"row":62,"column":8},"action":"remove","lines":["  "]},{"start":{"row":93,"column":12},"end":{"row":93,"column":13},"action":"insert","lines":[" "]},{"start":{"row":94,"column":6},"end":{"row":94,"column":8},"action":"remove","lines":["  "]},{"start":{"row":101,"column":31},"end":{"row":101,"column":32},"action":"remove","lines":[" "]},{"start":{"row":114,"column":16},"end":{"row":114,"column":24},"action":"insert","lines":["        "]},{"start":{"row":116,"column":13},"end":{"row":116,"column":24},"action":"insert","lines":["           "]},{"start":{"row":130,"column":12},"end":{"row":130,"column":13},"action":"insert","lines":[" "]},{"start":{"row":131,"column":5},"end":{"row":131,"column":11},"action":"remove","lines":["      "]},{"start":{"row":138,"column":15},"end":{"row":138,"column":25},"action":"remove","lines":["          "]},{"start":{"row":139,"column":15},"end":{"row":139,"column":25},"action":"remove","lines":["          "]},{"start":{"row":141,"column":22},"end":{"row":141,"column":25},"action":"remove","lines":["   "]},{"start":{"row":142,"column":18},"end":{"row":142,"column":22},"action":"insert","lines":["    "]},{"start":{"row":148,"column":6},"end":{"row":148,"column":7},"action":"remove","lines":[" "]},{"start":{"row":154,"column":5},"end":{"row":154,"column":6},"action":"remove","lines":[" "]},{"start":{"row":156,"column":15},"end":{"row":156,"column":27},"action":"insert","lines":["            "]},{"start":{"row":170,"column":15},"end":{"row":170,"column":18},"action":"remove","lines":["= 2"]},{"start":{"row":170,"column":21},"end":{"row":170,"column":30},"action":"insert","lines":["      = 2"]},{"start":{"row":184,"column":15},"end":{"row":184,"column":18},"action":"remove","lines":["= 3"]},{"start":{"row":184,"column":21},"end":{"row":184,"column":30},"action":"insert","lines":["      = 3"]},{"start":{"row":194,"column":6},"end":{"row":194,"column":15},"action":"remove","lines":["         "]}]]},"ace":{"folds":[],"scrolltop":3570.8000000000015,"scrollleft":0,"selection":{"start":{"row":199,"column":0},"end":{"row":199,"column":0},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"hash":"3fa175d6e8dc901a39f91240e2231c0b693b92c6","mime":"application/octet-stream","timestamp":1665510129869}